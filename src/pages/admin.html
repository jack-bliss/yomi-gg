<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin</title>
    <style>
        .highlighted {
            background-color: aqua;
        }
        #match_container div {
            padding: 10px;
            border-bottom: 1px solid aliceblue;
            font-family: Helvetica, Arial, sans-serif;
        }
        #match_container div span {
            display: inline-block;
            margin-right: 10px;
        }
    </style>
</head>
<body>

<form action="/smashgg/import/" method="post">

    <input type="text" name="tournament" placeholder="tournament slug" /><br />
    <input type="text" name="group_id" placeholder="group id" /><br />
    <input type="submit" value="Submit" />

</form>

<form id="get_matches">

    <label for="tournament_list">Tournaments</label>
    <select name="tournament" id="tournament_list">

    </select><br />
    <input type="submit" value="Load" />

</form>

<div id="match_container">

</div>

<script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>

<script>

$(() => {

    let allEvents = [];

    function listMatches(id) {
      const $mc = $("#match_container");
      const $tl = $("#tournament_list");
      $mc.html('');
      $.ajax({
        url: '/events/' + id + '/matches?direction=DESC',
        dataType: 'JSON',
        success: (matches) => {
          
          $mc.append(
            $("<div />")
              .append(
                $("<h2 />").text(allEvents[$tl[0].selectedIndex].name)
              )
              .append(
                $("<button />").text('update').attr('data-id', id).addClass('update')
              )
          );

          matches.forEach(m => {
            $mc.append(
              $("<div />")
                .addClass(() => m.highlight > 0 ? 'highlighted' : null)
                .append(
                  $("<span />")
                    .append(m.round + ': ' + m.entrant1tag + ' v ' + m.entrant2tag)
                )
                .append(
                  $("<button />")
                    .text('Highlight')
                    .attr('data-id', m.id)
                    .addClass('highlight')
                )
            );
          });
        }
      })
    }

    $.ajax({
      url: '/events',
      dataType: 'JSON',
      success: (events) => {
        allEvents = events;
        events.forEach(e => {
          $("#tournament_list").append(
            $("<option />").val(e.id).text(e.name)
          );
        });
      }
    });

    $("#get_matches").submit(e => {
      e.preventDefault();
      const id = $("#tournament_list").val();
      listMatches(id);
    });

    $("#match_container").on('click', '.highlight', e => {
      const $clicked = $(e.target);
      const $row = $clicked.parent();
      $.ajax({
        url: '/matches/highlight/',
        method: 'post',
        data: {
          id: $clicked.attr('data-id'),
          highlight: $row.hasClass('highlighted') ? 0 : 1,
        },
        dataType: 'JSON',
        success: (match) => {
          if (match.highlight === 0) {
            $row.removeClass('highlighted');
          } else {
            $row.addClass('highlighted');
          }
        }
      })
    });

    $("#match_container").on('click', '.update', e => {
      const $clicked = $(e.target);
      const id = $clicked.attr('data-id');
      $.ajax({
        url: '/matches/highlight/',
        method: 'post',
        data: {
          id: id,
        },
        dataType: 'JSON',
        success: (match) => {
          listMatches(id);
        }
      })
    });



});

</script>

</body>
</html>